<html>
    <head>
        <script src="jquery.min.js"></script>
        <script src="handlebars.js"></script>
        <script src="highstock.js"></script>
        <script src="exporting.js"></script>
        <script src="sprintf.js"></script>
        <script src="utils.js"></script>
        <script src="mappings.js"></script>
        <script src="d3.v3.min.js" charset="utf-8"></script>
        <script src="d3-tip.js"></script>
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="dist/css/bootstrap.min.css">

        <!-- Optional theme -->
        <link rel="stylesheet" href="dist/css/bootstrap-theme.min.css">
        
        <!-- Custom styles for this template -->
        <link href="starter-template.css" rel="stylesheet">

        <!-- Latest compiled and minified JavaScript -->
        <script src="dist/js/bootstrap.min.js"></script>
        <script src="bootbox.min.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-inverse navbar-fixed-top">
            <div class="container">
                <h2>Moteino dashboard</h2>
            </div>
        </nav>
        <div class="starter-template">
            <ul id="mainTabs" class="nav nav-tabs">
                <li role="presentation"><a href="#status" id="status-tab" data-toggle="tab">Status</a></li>
                <li role="presentation"><a href="#node" id="node-tab" data-toggle="tab">Node</a></li>
                <li role="presentation"><a href="#map" id="map-tab" data-toggle="tab">Map</a></li>
                <li class="dropdown">
                <a href="#" class="dropdown-toggle" id="graph-tab" data-toggle="dropdown">Graph<span class="caret"></span></a>
                    <ul class="dropdown-menu" id="dropdown-menu" role="menu">
                    </ul>
                </li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane fade" id="status"></div>
                <div class="tab-pane fade" id="node"></div>
                <div class="tab-pane fade" id="map">
                    <object type="image/svg+xml" data="map.svg" id="svg-map"></object>
                </div>
                <div class="tab-pane fade" id="graph"></div>
            </div>
        </div>
    </body>
    <script>
        var menu = document.getElementById('dropdown-menu');
        for (var key in graphs_mapping){
            var li = document.createElement("li");

            var href = document.createElement("a");
            href.setAttribute('href', '#graph');
            href.setAttribute('tabindex', '-1');
            href.setAttribute('data-toggle', 'tab')

            var txt = document.createTextNode(key);

            href.appendChild(txt);
            li.appendChild(href);

            menu.appendChild(li);
        }

        for (var key in disabled_elems){
            var elem = document.getElementById(disabled_elems[key]);
            $(elem).hide();
        }

        Highcharts.setOptions({
            global: {
                useUTC: false,
            }
        });
    </script>
    <script>
        api_endpoint = parent.location.protocol+'//'+window.location.hostname+':'+window.location.port+'/api';

        $('.nav-tabs a').click(function(){
            $(this).tab('show');
        })
        $(document).on('ready', function() {
            $('.nav-tabs a').on('show.bs.tab', function(ev){
                var href = $(ev.target).attr("href");

                if ("refreshTimer" in window){
                    clearInterval(refreshTimer);
                }
                refreshTimer = setInterval(refreshTab, 1000*60, this);

                if (href == '#status'){
                    $.getJSON(api_endpoint + '/action/status').done(function(data){
                        var status_html = ''
                        for (var k in status_mapping){
                            var source = $(href + k + 'Template').html();
                            var template = Handlebars.compile(source);
                            var group_data = filterObject(data, status_mapping[k]);

                            status_html += template(group_data);
                        }

                        $(href).html(status_html);
                    });
                } else if (href == '#node'){
                    $.getJSON(api_endpoint + '/node').done(function(data){
                        var nodes = {'Online': [], 'Offline': []}

                        var node_html = '';

                        for (var k in data){
                            if (data[k]['data'].length){
                                nodes['Online'].push(data[k]);
                            } else {
                                nodes['Offline'].push(data[k]);
                            }
                        }
                        for (var k in nodes){
                            var source = $(href + k + 'Template').html();
                            var template = Handlebars.compile(source);

                            node_html += template(nodes[k]);
                        }

                        $(href).html(node_html);
                    });
                } else if (href == '#map'){
                    $.getJSON(api_endpoint + '/node').done(function(data){
                        var svg_map = document.getElementById("svg-map").contentDocument;
                        for (var k in data){
                            var svg_board = d3.select(svg_map).select("#board-" + data[k]['name']);
                            var tip = d3.tip()
                                .attr('class', 'd3-tip')
                                .offset([120, 15])
                                .direction('n')

                            if (data[k]['data'].length){
                                svg_board.attr("fill", "#008000");
                                var source = $('#mapOnlineTemplate').html();
                                var template = Handlebars.compile(source);
                            } else {
                                var source = $('#mapOfflineTemplate').html();
                                var template = Handlebars.compile(source);
                                svg_board.attr("fill", "#FF0000");
                            }

                            tip.html(template(data[k]));
                            svg_board.call(tip);
                            svg_board.on('mouseover', tip.show);
                            svg_board.on('mouseout', tip.hide);
                        }
                    });
                } else if (href == '#graph'){
                    var graph_type = $(ev.target).text().toLowerCase();
                    function callback(data){
                        handleGraphRequest(graph_type, data);
                    }

                    $.postJSON(api_endpoint + '/graph/' + graph_type, '{"last_available": 10}', callback);
                }
            });
        });
    </script>
    <script id="mapOnlineTemplate" type="x-handlebars-template">
        Board: {{name}}<br />
        {{#data}}
            {{0}}: {{1}}<br />
        {{/data}}
    </script>
    <script id="mapOfflineTemplate" type="x-handlebars-template">
        Board: {{name}}<br />
        Offline
    </script>
    <script id="nodeOnlineTemplate" type="x-handlebars-template">
        <h3>Online nodes</h3>
        {{#each this}}
            <h4>
                <span style="cursor: pointer;" class="label label-default" onclick="showCommandDialog('{{name}}')">{{desc}} ({{name}})</span>
            </h4>
            <h5>
                {{#data}}
                    <span class="label label-info">{{0}}: {{1}}</span>&nbsp;
                {{/data}}
            </h5>
        {{/each}}
    </script>
    <script id="nodeOfflineTemplate" type="x-handlebars-template">
        <h3>Offline nodes</h3>
        <h4>
            {{#each this}}
                <span class="label label-danger">{{desc}} ({{name}})</span>
            {{/each}}
        </h4>
    </script>
    <script id="statusServiceTemplate" type="x-handlebars-template">
        <h3>Service status</h3>
        <div class="status-wrapper">
            <div class="row">
                <h4>
                {{#each this}}
                    <div class="col-sm-8 margin">{{@key}}</div>
                    <div class="col-sm-4 margin">
                    {{#if this}}
                        <span style="cursor: pointer;" class="label label-success" onclick="invertStatus('{{@key}}', '{{this}}')">Enabled</span>
                    {{else}}
                        <span style="cursor: pointer;" class="label label-danger" onclick="invertStatus('{{@key}}', '{{this}}')">Disabled</span>
                    {{/if}}
                    </div>
               {{/each}}
                </h4>
            </div>
        </div>
    </script>
    <script id="statusStatusTemplate" type="x-handlebars-template">
        <h3>Status</h3>
        <div class="status-wrapper">
            <div class="row">
                <h4>
                {{#each this}}
                    <div class="col-sm-8 margin">{{@key}}</div>
                    <div class="col-sm-4 margin">
                    {{#if this}}
                        <span style="cursor: pointer;" class="label label-success" onclick="invertStatus('{{@key}}', '{{this}}')">True</span>
                    {{else}}
                        <span style="cursor: pointer;" class="label label-danger" onclick="invertStatus('{{@key}}', '{{this}}')">False</span>
                    {{/if}}
                    </div>
               {{/each}}
                </h4>
            </div>
        </div>
    </script>
</html>
